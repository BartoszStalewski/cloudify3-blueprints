tosca_definitions_version: cloudify_dsl_1_0

#######
# Cloudify Blueprint which describes a xap cluster (single node)
#
imports:
    - http://www.getcloudify.org/spec/cloudify/3.1/types.yaml
    - os-inputs.yaml
    - http://www.getcloudify.org/spec/diamond-plugin/1.1/plugin.yaml
    - http://www.getcloudify.org/spec/openstack-plugin/1.1/plugin.yaml
    
node_types:
    vm_host:
        derived_from: cloudify.openstack.nodes.Server
        properties:
            cloudify_agent:
              default:
                user: "ubuntu"

    xap.monitoredServer:
        derived_from: cloudify.nodes.Compute
        interfaces:
          cloudify.interfaces.monitoring_agent:
              install:
                implementation: diamond.diamond_agent.tasks.install
                inputs:
                  diamond_config:
                    default:
                      interval: 1
              start: diamond.diamond_agent.tasks.start
              stop: diamond.diamond_agent.tasks.stop
              uninstall: diamond.diamond_agent.tasks.uninstall

          cloudify.interfaces.monitoring:
              start:
                implementation: diamond.diamond_agent.tasks.add_collectors
                inputs:
                  collectors_config:
                    default:
                      CPUCollector: {}
                      MemoryCollector: {}
                      LoadAverageCollector: {}
                      DiskUsageCollector:
                        config:
                          devices: x?vd[a-z]+[0-9]*$
                      NetworkCollector: {}

    xap_type:
        derived_from: cloudify.nodes.ApplicationServer
        properties:
            interfacename:
                type: string
                default: 'eth0'
            GSA_JAVA_OPTIONS:
                type: string
                default: ''
            gsm_cnt:
                type: integer
                default: 0
            global_gsm_cnt:
                type: integer
                default: 0
            GSM_JAVA_OPTIONS:
                type: string
                default: ''
            lus_cnt:
                type: integer
                default: 0
            lus_port:
                type: integer
                default: 0
            LUS_JAVA_OPTIONS:
                type: string
                default: ''
            global_lus_cnt:
                type: integer
                default: 0
            gsc_cnt:
                type: integer
                default: 0
            GSC_JAVA_OPTIONS:
                type: string
                default: ''
            zones:
                type: string
                default: ''
            download_url:
                type: string
                default: http://192.168.10.199:8000/gigaspaces-xap-premium-10.1.0-m10-b12591-27.zip
            license_key:
                type: string
                default: ''
            lrmi_comm_min_port:
                type: integer
                default: { get_input: lrmi_comm_min_port }
            lrmi_comm_max_port:
                type: integer
                default: { get_input: lrmi_comm_max_port }

    xap_webui_type:
        derived_from: cloudify.nodes.WebServer
        properties:
            interfacename:
                type: string
                default: 'eth0'
            webui_port:
                type: integer
                default: { get_input: xap_management_webui_port }

    demo_shell_type:
        derived_from: cloudify.nodes.WebServer
        properties:
            interfacename:
                type: string
                default: 'eth0'
            port:
                type: integer
                default: 8080
            butterfly_repo:
                type: string
                default: https://github.com/CloudifySource/butterfly.git
            demo_url:
                type: string
                default: https://github.com/Gigaspaces/XAP-Interactive-Tutorial/archive/master.zip
            lrmi_comm_min_port:
                type: integer
                default: { get_input: lrmi_comm_min_port }
            lrmi_comm_max_port:
                type: integer
                default: { get_input: lrmi_comm_max_port }

    xap_gateway_type:
        derived_from: xap_type
        properties:
            space_name:
                type: string
                default: { get_input: xap_gateway_spacename }
            space_zones:
                type: string
                default: { get_input: xap_grid_zones }
            restpu_zones:
                type: string
                default: { get_input: xap_management_zones }
            gsc_cnt:
                type: integer
                default: { get_input: xap_gateway_gscs_count }
            zones:
                type: string
                default: { get_input: xap_gateway_zones }
            discport:
                type: integer
                default: { get_input: xap_gateway_discoport }
            commport:
                type: integer
                default: { get_input: xap_gateway_commport }
            gwname:
                type: string
                default: { get_input: xap_gateway_gwname }
            sources:
                type: string
                default: { get_input: xap_gateway_sources }
            targets:
                type: string
                default: { get_input: xap_gateway_targets }
            lookups:
                default: { get_input: xap_gateway_lookups }

    xap_datagrid_type:
        derived_from: xap_type

node_templates:
        xap_management_security_group:
            type: cloudify.openstack.nodes.SecurityGroup
            properties:
                security_group:
                    name: xap_management_security_group
                rules:
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 8080
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 8888
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 9099
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104

        xap_datagrid_security_group:
            type: cloudify.openstack.nodes.SecurityGroup
            properties:
                security_group:
                    name: xap_datagrid_security_group
                rules:
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104

        xap_gateway_security_group:
            type: cloudify.openstack.nodes.SecurityGroup
            properties:
                security_group:
                    name: xap_gateway_security_group
                rules:
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7122
                      port_range_max: 7222
                    - remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port: 4174
                    - remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104
                    - direction: egress
                      remote_ip_prefix: 0.0.0.0/0
                      port_range_min: 7102
                      port_range_max: 7104

        xap_management_vm:
            type: vm_host
            instances:
                deploy: 1
            properties:
              server:
                  image: "d81ccdfe-7482-460e-a7ce-69ea29aa129b"
                  flavor: "ba4e08fd-e4c5-4233-a906-f1bb31cb659d"
                  security_groups: ['yohanaxap_management_security_group']

            relationships:
                - target: floatingip
                  type: cloudify.openstack.server_connected_to_floating_ip
                - target: xap_management_security_group
                  type: cloudify.relationships.depends_on

        floatingip:
            type: cloudify.openstack.nodes.FloatingIP
        floatingip2:
                    type: cloudify.openstack.nodes.FloatingIP
        floatingip3:
                    type: cloudify.openstack.nodes.FloatingIP

        xap_datagrid_vm:
            type: vm_host
            instances:
                deploy: 1
            properties:
              server:
                  image: "d81ccdfe-7482-460e-a7ce-69ea29aa129b"
                  flavor: "ba4e08fd-e4c5-4233-a906-f1bb31cb659d"
                  security_groups: ['yohanaxap_datagrid_security_group']
            relationships:
                - target: floatingip2
                  type: cloudify.openstack.server_connected_to_floating_ip
                - target: xap_datagrid_security_group
                  type: cloudify.relationships.depends_on

        xap_gateway_vm:
            type: vm_host
            instances:
                deploy: 1
            properties:
              server:
                  image: "d81ccdfe-7482-460e-a7ce-69ea29aa129b"
                  flavor: "ba4e08fd-e4c5-4233-a906-f1bb31cb659d"
                  security_groups: ['yohanaxap_gateway_security_group']
            relationships:
                - target: floatingip3
                  type: cloudify.openstack.server_connected_to_floating_ip
                - target: xap_gateway_security_group
                  type: cloudify.relationships.depends_on

        xap_management:
            type: xap_type
            properties:
                lus_cnt: 1
                global_lus_cnt: 0
                gsm_cnt: 1
                global_gsm_cnt: 0
                gsc_cnt: { get_input: xap_management_gscs_count }
                zones: { get_input: xap_management_zones }
                GSM_JAVA_OPTIONS: -Xms128m -Xmx128m
            relationships:
                -   target: xap_management_vm
                    type: cloudify.relationships.contained_in
            interfaces:
                admin.commands:
                  deploy_grid:
                      implementation: xap_admin_plugin.xap_admin_plugin.tasks.deploy_grid
                      inputs:
                          script: xap-scripts/deploy-grid.sh
                  undeploy_grid:
                      implementation: xap_admin_plugin.xap_admin_plugin.tasks.undeploy_grid
                      inputs:
                          script: xap-scripts/undeploy-grid.sh
                  deploy_pu:
                      implementation: xap_admin_plugin.xap_admin_plugin.tasks.deploy_pu
                      inputs:
                          script: xap-scripts/deploy-pu.sh

                cloudify.interfaces.lifecycle:
                  create: xap-scripts/install-xap.sh
                  start: xap-scripts/start-xap.sh
                  stop: xap-scripts/stop-xap.sh


        xap_datagrid:
            type: xap_datagrid_type
            properties:
                gsc_cnt: { get_input: xap_grid_gscs_count }
                zones: { get_input: xap_grid_zones }
            relationships:
                -   target: xap_datagrid_vm
                    type: cloudify.relationships.contained_in
                -   target: xap_management
                    type: xap_connected_to_lus
            interfaces:
                cloudify.interfaces.lifecycle:
                  create: xap-scripts/install-xap.sh
                  start: xap-scripts/start-xap.sh
                  stop: xap-scripts/stop-xap.sh

        xap_gateway:
            type: xap_gateway_type
            properties:
                space_name: { get_input: xap_gateway_spacename }
                space_zones: { get_input: xap_grid_zones }
                restpu_zones: { get_input: xap_management_zones }
                gsc_cnt: { get_input: xap_gateway_gscs_count }
                zones: { get_input: xap_gateway_zones }
                discport: { get_input: xap_gateway_discoport }
                commport: { get_input: xap_gateway_commport }
                gwname: { get_input: xap_gateway_gwname }
                sources: { get_input: xap_gateway_sources }
                targets: { get_input: xap_gateway_targets }
                lookups: { get_input: xap_gateway_lookups }

            relationships:
                -   target: xap_gateway_vm
                    type: cloudify.relationships.contained_in
                -   target: xap_management
                    type: xap_connected_to_lus
                -   target: xap_datagrid
                    type: cloudify.relationships.depends_on
            interfaces:
                cloudify.interfaces.lifecycle:
                  create: xap-scripts/install-xap.sh
                  start: xap-scripts/start-gateway.sh
                  stop: xap-scripts/stop-xap.sh

        webui:
            type: xap_webui_type
            interfaces:
                cloudify.interfaces.lifecycle:
                  start: xap-scripts/start-ui.sh
                  stop: xap-scripts/stop-ui.sh
            relationships:
                - target: xap_management_vm
                  type: cloudify.relationships.contained_in
                - target: xap_management
                  type: cloudify.relationships.depends_on

        demo_shell:
            type: demo_shell_type
            interfaces:
                cloudify.interfaces.lifecycle:
                  create: butterfly-scripts/install.sh
                  start: butterfly-scripts/start.sh
            relationships:
                - target: xap_management_vm
                  type: cloudify.relationships.contained_in
                - target: xap_management
                  type: cloudify.relationships.depends_on


groups:
    autohealing_group:
      members: [xap_management_vm,webui]
      policies:
        simple_autoheal_policy:
          type: cloudify.policies.types.host_failure
          triggers:
            auto_heal_trigger:
              type:
                cloudify.policies.triggers.execute_workflow
              parameters:
                workflow: auto_heal_workflow
                allow_custom_parameters: True
                workflow_parameters:
                  node_id:
                    get_property: ['SELF', 'failing_node']
                  diagnose_value:
                    get_property: ['SELF', 'diagnose']

outputs:

    management_ui:
      description: XAP UI URL
      value:
        ip: {  get_attribute: [ xap_management_vm,  ip_address ] }
        port: 7104


plugins:
    xap_config_plugin:
        executor: host_agent
        source: xap-config-plugin

    xap_admin_plugin:
        executor: host_agent
        source: xap-admin-plugin

workflows:
    deploy_grid:
        mapping: workflows/deploy_grid.py
        parameters:
            grid_name:
              default: dataGrid
            schema:
              default: partitioned-sync2backup
            partitions:
              default: 1
            backups:
              default: 0
            max_per_vm:
              default: 0
            max_per_machine:
              default: 0
    undeploy_grid:
        mapping: workflows/undeploy_grid.py
        parameters:
            grid_name:
              default: dataGrid
    deploy_pu:
        mapping: workflows/deploy_pu.py
        parameters:
            pu_url:
              default: ""
            override_pu_name:
              default: ""
            schema:
              default: partitioned-sync2backup
            partitions:
              default: 1
            backups:
              default: 0
            max_per_vm:
              default: 0
            max_per_machine:
              default: 0
    auto_heal_workflow:
        mapping: default_workflows.cloudify.plugins.workflows.auto_heal_reinstall_node_subgraph
        parameters:
            node_id:
              description: none


relationships:
    xap_connected_to_lus:
        derived_from: cloudify.relationships.connected_to
        source_interfaces:
            cloudify.interfaces.relationship_lifecycle:
                postconfigure:
                    implementation: xap-scripts/get_locators.py
                    inputs: {}
